---
interface Props {
  contentSelector?: string;
}

const { contentSelector = '.post-content' } = Astro.props;

const languages = [
  { code: 'en', label: 'English' },
  { code: 'es', label: 'Español' },
  { code: 'fr', label: 'Français' },
  { code: 'de', label: 'Deutsch' },
  { code: 'pt', label: 'Português' },
  { code: 'it', label: 'Italiano' },
  { code: 'ja', label: '日本語' },
  { code: 'zh', label: '中文' },
];
---

<div class="translator-wrapper" data-content-selector={contentSelector}>
  <div class="translator-container" style="display: none;">
    <label class="translator-label">
      <span class="translator-icon">⌘</span>
      Translate:
    </label>
    <select class="translator-select">
      <option value="">Original</option>
      {languages.map((lang) => (
        <option value={lang.code}>{lang.label}</option>
      ))}
    </select>
    <span class="translator-status"></span>
  </div>
  <p class="translator-unavailable" style="display: none;">
    Translation requires Chrome 138+ with Translator API enabled.
  </p>
</div>

<script>
  interface TranslatorInstance {
    translate(text: string): Promise<string>;
  }

  interface TranslatorAPI {
    availability(options: { sourceLanguage: string; targetLanguage: string }): Promise<string>;
    create(options: { 
      sourceLanguage: string; 
      targetLanguage: string;
      monitor?: (m: any) => void;
    }): Promise<TranslatorInstance>;
  }

  declare global {
    interface Window {
      Translator: TranslatorAPI;
    }
  }

  function initTranslator() {
    const wrappers = document.querySelectorAll('.translator-wrapper');

    wrappers.forEach((wrapper) => {
      const container = wrapper.querySelector('.translator-container') as HTMLElement;
      const unavailable = wrapper.querySelector('.translator-unavailable') as HTMLElement;
      const select = wrapper.querySelector('.translator-select') as HTMLSelectElement;
      const status = wrapper.querySelector('.translator-status') as HTMLElement;
      const contentSelector = wrapper.getAttribute('data-content-selector') || '.post-content';
      const contentElement = document.querySelector(contentSelector);

      if (!contentElement) return;

      // Check if Translator API is available
      if ('Translator' in window) {
        container.style.display = 'flex';
        unavailable.style.display = 'none';
      } else {
        container.style.display = 'none';
        unavailable.style.display = 'block';
        return;
      }

      // Store original content
      const originalHTML = contentElement.innerHTML;
      let currentLang = '';
      let isTranslating = false;

      select.addEventListener('change', async () => {
        const targetLang = select.value;

        if (isTranslating) return;

        // Reset to original
        if (!targetLang) {
          contentElement.innerHTML = originalHTML;
          currentLang = '';
          status.textContent = '';
          return;
        }

        // Don't re-translate same language
        if (targetLang === currentLang) return;

        isTranslating = true;
        status.textContent = '⏳';
        select.disabled = true;

        try {
          // Check availability
          const availability = await window.Translator.availability({
            sourceLanguage: 'en',
            targetLanguage: targetLang,
          });

          if (availability === 'unavailable') {
            status.textContent = '✗ Unavailable';
            isTranslating = false;
            select.disabled = false;
            return;
          }

          // Create translator
          const translator = await window.Translator.create({
            sourceLanguage: 'en',
            targetLanguage: targetLang,
            monitor(m: any) {
              m.addEventListener('downloadprogress', (e: any) => {
                status.textContent = `⏳ ${Math.round(e.loaded * 100)}%`;
              });
            },
          });

          // Get text nodes and translate
          status.textContent = '⏳ Translating...';
          
          // Reset to original first
          contentElement.innerHTML = originalHTML;

          // Translate text content
          const walker = document.createTreeWalker(
            contentElement,
            NodeFilter.SHOW_TEXT,
            null
          );

          const textNodes: Text[] = [];
          let node: Text | null;
          while ((node = walker.nextNode() as Text)) {
            if (node.textContent && node.textContent.trim().length > 0) {
              textNodes.push(node);
            }
          }

          // Translate each text node
          for (const textNode of textNodes) {
            const original = textNode.textContent || '';
            if (original.trim()) {
              try {
                const translated = await translator.translate(original);
                textNode.textContent = translated;
              } catch (e) {
                // Keep original if translation fails
              }
            }
          }

          currentLang = targetLang;
          status.textContent = '✓';
          setTimeout(() => {
            status.textContent = '';
          }, 2000);

        } catch (error) {
          console.error('Translation error:', error);
          status.textContent = '✗ Error';
          contentElement.innerHTML = originalHTML;
        }

        isTranslating = false;
        select.disabled = false;
      });
    });
  }

  // Initialize on load and navigation
  initTranslator();
  document.addEventListener('astro:page-load', initTranslator);
</script>

<style>
  .translator-wrapper {
    margin-bottom: var(--spacing-lg);
  }

  .translator-container {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-sm) var(--spacing-md);
    border: var(--border);
    background: var(--bg);
    width: fit-content;
  }

  .translator-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    opacity: 0.7;
  }

  .translator-icon {
    font-size: 1rem;
  }

  .translator-select {
    font-family: var(--font-main);
    font-size: 0.875rem;
    background: var(--bg);
    color: var(--text);
    border: var(--border);
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    min-width: 120px;
  }

  .translator-select:focus {
    outline: none;
    box-shadow: 0 0 0 1px var(--text);
  }

  .translator-select:disabled {
    opacity: 0.5;
    cursor: wait;
  }

  .translator-status {
    font-size: 0.875rem;
    min-width: 80px;
  }

  .translator-unavailable {
    font-size: 0.75rem;
    opacity: 0.5;
    font-style: italic;
    margin: 0;
  }
</style>

